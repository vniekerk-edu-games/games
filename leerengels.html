<!DOCTYPE html>
<html lang="af">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taal Avontuur - Slim Vasvra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f0f9ff; /* Light Blue Sky */
            touch-action: manipulation;
        }
        .btn-pop {
            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-pop:active {
            transform: scale(0.95);
        }
        .loading-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .correct-anim {
            animation: successPop 0.5s ease-out;
        }
        @keyframes successPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #86efac; }
            100% { transform: scale(1); }
        }
        .shake-anim {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <!-- Navbar -->
    <nav class="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center gap-2">
            <i data-lucide="rocket" class="h-6 w-6"></i>
            <h1 class="text-xl font-bold tracking-tight">Taal Avontuur</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleMute()" class="p-2 hover:bg-indigo-700 rounded-full transition" id="mute-btn">
                <i data-lucide="volume-2" class="h-5 w-5" id="mute-icon"></i>
            </button>
            <div class="bg-indigo-800 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                <i data-lucide="star" class="h-4 w-4 text-yellow-400 fill-yellow-400"></i>
                <span id="score">0</span>
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-indigo-700 rounded-full transition">
                <i data-lucide="settings" class="h-5 w-5"></i>
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <main class="flex-grow container mx-auto p-4 max-w-xl flex flex-col items-center justify-center relative">
        
        <!-- Settings Modal (API Key) -->
        <div id="settings-modal" class="hidden absolute top-0 left-0 w-full h-full bg-white/95 z-50 flex flex-col p-6 rounded-xl shadow-xl">
            <h2 class="text-2xl font-bold mb-4 text-indigo-900">Instellings ‚öôÔ∏è</h2>
            <p class="mb-2 text-sm text-gray-600">Voer jou Google Gemini API sleutel in:</p>
            <input type="password" id="api-key-input" placeholder="Paste API Key here..." class="w-full p-3 border-2 border-indigo-200 rounded-lg mb-4 focus:border-indigo-500 outline-none">
            <div class="flex gap-2">
                <button onclick="saveSettings()" class="flex-1 bg-green-500 text-white p-3 rounded-lg font-bold">Stoor</button>
                <button onclick="toggleSettings()" class="flex-1 bg-gray-300 text-gray-700 p-3 rounded-lg font-bold">Kanselleer</button>
            </div>
            <p class="mt-4 text-xs text-gray-500">Kry 'n gratis sleutel by <a href="https://aistudio.google.com/" target="_blank" class="underline text-indigo-600">Google AI Studio</a>.</p>
        </div>

        <!-- Grade Level Display -->
        <div class="w-full mb-6 flex justify-between items-end px-2">
            <div>
                <span class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Moeilikheidsgraad</span>
                <div class="text-2xl font-bold text-indigo-900 flex items-center gap-2">
                    Graad <span id="grade-display">1</span>
                    <span id="grade-indicator" class="text-lg">üë∂</span>
                </div>
            </div>
            <div class="text-right">
                <div class="flex gap-1" id="streak-dots">
                    <!-- Dots injected by JS -->
                </div>
                <span class="text-xs text-gray-400" id="streak-label">Nog 3 vir volgende vlak</span>
            </div>
        </div>

        <!-- Question Card -->
        <div id="quiz-card" class="bg-white w-full rounded-3xl shadow-xl border-b-8 border-indigo-100 p-6 text-center relative overflow-hidden min-h-[400px] flex flex-col justify-center">
            
            <!-- Loading State -->
            <div id="loading-state" class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center z-20">
                <div class="text-6xl mb-4 animate-bounce">ü§ñ</div>
                <p class="text-indigo-600 font-bold text-lg loading-pulse">Die robot dink...</p>
            </div>

            <!-- Start State -->
            <div id="start-state" class="absolute inset-0 bg-white flex flex-col items-center justify-center z-10 p-6">
                <div class="text-6xl mb-6">üéì</div>
                <h2 class="text-3xl font-bold text-indigo-900 mb-2">Gereed?</h2>
                <p class="text-gray-600 mb-8">Kom ons kyk hoeveel woorde jy ken!</p>
                <button onclick="startGame()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg btn-pop hover:bg-indigo-700">
                    Begin!
                </button>
            </div>

            <!-- Question Content -->
            <div id="question-content" class="flex flex-col h-full hidden">
                <div class="mb-2 text-indigo-500 font-semibold text-sm uppercase tracking-widest" id="question-type">AFRIKAANS ‚ûî ENGELS</div>
                
                <div class="flex-grow flex flex-col justify-center items-center py-4">
                    <span id="emoji-display" class="text-6xl mb-4 block transform transition-transform hover:scale-110 duration-300"></span>
                    <h2 id="question-word" class="text-4xl font-black text-gray-800 break-words w-full"></h2>
                </div>

                <div id="options-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-auto">
                    <!-- Buttons injected via JS -->
                </div>
            </div>

        </div>

        <!-- Feedback Toast -->
        <div id="feedback-toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-10 z-50 pointer-events-none">
            <span id="feedback-icon" class="text-xl"></span>
            <span id="feedback-text" class="font-bold"></span>
        </div>

    </main>

    <script>
        // --- State Management ---
        const state = {
            grade: 1,
            score: 0,
            consecutiveCorrect: 0,
            consecutiveIncorrect: 0,
            customApiKey: localStorage.getItem('taal_api_key') || "",
            isProcessing: false,
            currentQuestion: null,
            muted: false
        };

        // Initialize Lucide Icons
        lucide.createIcons();

        // --- Sound Effects System (Web Audio API) ---
        const AudioSys = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            playTone: function(freq, type, duration, startTime = 0) {
                if (state.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime + startTime;
                osc.start(now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                osc.stop(now + duration);
            },
            correct: function() {
                this.init();
                // Happy "Ding-Dong"
                this.playTone(523.25, 'sine', 0.1, 0); // C5
                this.playTone(1046.50, 'sine', 0.4, 0.1); // C6
            },
            incorrect: function() {
                this.init();
                // Low "Buzz"
                this.playTone(150, 'sawtooth', 0.3, 0);
            },
            levelUp: function() {
                this.init();
                // Major Fanfare
                this.playTone(523.25, 'triangle', 0.1, 0);   // C
                this.playTone(659.25, 'triangle', 0.1, 0.1); // E
                this.playTone(783.99, 'triangle', 0.1, 0.2); // G
                this.playTone(1046.50, 'triangle', 0.6, 0.3); // High C
            },
            levelDown: function() {
                this.init();
                if (state.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.4);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.4);
                osc.stop(this.ctx.currentTime + 0.4);
            }
        };

        // --- API & Logic ---
        const systemApiKey = "AIzaSyCPoE0I9RTTHskyn11U4b94uUioc6UHXdc"; // Provided by environment runtime if available

        function getApiKey() {
            return state.customApiKey || systemApiKey;
        }

        async function fetchQuestion() {
            setLoading(true);
            const apiKey = getApiKey();
            
            // If no key, simulate a fallback (or use hardcoded set for demo purposes if needed)
            // Ideally, we warn the user, but for smoothness let's try to fetch.
            
            const direction = Math.random() > 0.5 ? 'AF_TO_EN' : 'EN_TO_AF';
            
            const prompt = `
                Generate a single vocabulary word suitable for a Grade ${state.grade} child (age ${6 + state.grade}) in South Africa.
                Return a strict JSON object with no markdown formatting.
                The JSON must have these fields:
                - "af": The word in Afrikaans.
                - "en": The word in English.
                - "emoji": A single relevant emoji (optional, use empty string if abstract).
                - "distractors_en": Array of 3 English words that are wrong but related (same category).
                - "distractors_af": Array of 3 Afrikaans words that are wrong but related.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json"
                        }
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const json = JSON.parse(text);

                // Prepare Question Object
                state.currentQuestion = {
                    direction: direction,
                    correctWord: direction === 'AF_TO_EN' ? json.en : json.af,
                    questionWord: direction === 'AF_TO_EN' ? json.af : json.en,
                    emoji: json.emoji,
                    options: shuffleArray([
                        direction === 'AF_TO_EN' ? json.en : json.af,
                        ...(direction === 'AF_TO_EN' ? json.distractors_en : json.distractors_af)
                    ])
                };

                renderQuestion();

            } catch (error) {
                console.error(error);
                // Fallback for demo/error (Simple static fallback to keep app alive)
                useFallbackQuestion();
            } finally {
                setLoading(false);
            }
        }

        function useFallbackQuestion() {
            const fallbacks = [
                {af: "Fiets", en: "Bicycle", emoji: "üö≤", d_en: ["Car", "Bus", "Train"], d_af: ["Motor", "Bus", "Trein"]},
                {af: "Boom", en: "Tree", emoji: "üå≥", d_en: ["Flower", "Grass", "Leaf"], d_af: ["Blom", "Gras", "Blaar"]},
                {af: "Sambreel", en: "Umbrella", emoji: "‚òÇÔ∏è", d_en: ["Rain", "Coat", "Hat"], d_af: ["Re√´n", "Jas", "Hoed"]}
            ];
            const random = fallbacks[Math.floor(Math.random() * fallbacks.length)];
            const direction = Math.random() > 0.5 ? 'AF_TO_EN' : 'EN_TO_AF';

            state.currentQuestion = {
                direction: direction,
                correctWord: direction === 'AF_TO_EN' ? random.en : random.af,
                questionWord: direction === 'AF_TO_EN' ? random.af : random.en,
                emoji: random.emoji,
                options: shuffleArray([
                    direction === 'AF_TO_EN' ? random.en : random.af,
                    ...(direction === 'AF_TO_EN' ? random.d_en : random.d_af)
                ])
            };
            renderQuestion();
        }

        // --- UI Rendering ---

        function renderQuestion() {
            const q = state.currentQuestion;
            document.getElementById('question-type').textContent = q.direction === 'AF_TO_EN' ? "WAT IS DIE ENGELS VIR:" : "WAT IS DIE AFRIKAANS VIR:";
            document.getElementById('question-word').textContent = q.questionWord;
            document.getElementById('emoji-display').textContent = q.emoji || "‚ùì";

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-indigo-50 hover:bg-indigo-100 text-indigo-900 font-bold py-4 px-6 rounded-xl border-2 border-indigo-200 transition-all btn-pop text-lg";
                btn.textContent = opt;
                btn.onclick = () => handleAnswer(opt, btn);
                grid.appendChild(btn);
            });
            
            // Update UI indicators
            updateStreakDisplay();
        }

        function handleAnswer(selected, btnElement) {
            if (state.isProcessing) return;
            state.isProcessing = true;

            const isCorrect = selected === state.currentQuestion.correctWord;

            if (isCorrect) {
                // Correct Logic
                AudioSys.correct();
                btnElement.classList.remove('bg-indigo-50', 'border-indigo-200');
                btnElement.classList.add('bg-green-500', 'border-green-600', 'text-white', 'correct-anim');
                showToast(true, "Mooi so!");
                
                state.score += 10 + (state.grade * 2);
                state.consecutiveCorrect++;
                state.consecutiveIncorrect = 0;

                // Level Up Logic (3 in a row)
                if (state.consecutiveCorrect >= 3) {
                    // Delay level up slightly so the correct sound finishes
                    setTimeout(levelUp, 600);
                } else {
                    setTimeout(() => {
                        fetchQuestion();
                        state.isProcessing = false;
                    }, 1000);
                }
            } else {
                // Incorrect Logic
                AudioSys.incorrect();
                btnElement.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake-anim');
                showToast(false, "Oeps! Probeer weer.");

                state.consecutiveCorrect = 0;
                state.consecutiveIncorrect++;

                // Level Down Logic (2 wrong in a row)
                if (state.consecutiveIncorrect >= 2) {
                    setTimeout(levelDown, 600);
                }

                setTimeout(() => {
                    // Reveal correct answer briefly
                    const buttons = document.querySelectorAll('#options-grid button');
                    buttons.forEach(b => {
                        if (b.textContent === state.currentQuestion.correctWord) {
                            b.classList.add('bg-green-500', 'text-white');
                        }
                    });
                    
                    setTimeout(() => {
                        fetchQuestion();
                        state.isProcessing = false;
                    }, 1500);
                }, 500);
            }
            
            document.getElementById('score').textContent = state.score;
        }

        // --- Difficulty Logic ---

        function levelUp() {
            AudioSys.levelUp();
            state.grade++;
            state.consecutiveCorrect = 0; // Reset streak
            showToast(true, `Graad ${state.grade}! Jy is slim! üöÄ`);
            updateGradeDisplay();
            setTimeout(() => {
                fetchQuestion();
                state.isProcessing = false;
            }, 1500);
        }

        function levelDown() {
            AudioSys.levelDown();
            if (state.grade > 1) {
                state.grade--;
                showToast(false, `Terug na Graad ${state.grade}. Ons oefen nog bietjie.`);
            }
            state.consecutiveIncorrect = 0; // Reset streak
            updateGradeDisplay();
        }

        function updateGradeDisplay() {
            document.getElementById('grade-display').textContent = state.grade;
            const indicators = ["üë∂", "üë¶", "üìö", "üß†", "üéì", "üöÄ", "ü™ê"];
            const icon = indicators[Math.min(state.grade - 1, indicators.length - 1)];
            document.getElementById('grade-indicator').textContent = icon;
        }

        function updateStreakDisplay() {
            const container = document.getElementById('streak-dots');
            container.innerHTML = '';
            
            // Show dots for correct streak (goal is 3)
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full ${i < state.consecutiveCorrect ? 'bg-green-500' : 'bg-gray-200'}`;
                container.appendChild(dot);
            }
            
            const remaining = 3 - state.consecutiveCorrect;
            document.getElementById('streak-label').textContent = remaining === 0 ? "Vlak op!" : `Nog ${remaining} vir volgende vlak`;
        }


        // --- Utilities ---

        function startGame() {
            AudioSys.init(); // Initialize Audio Context on user gesture
            document.getElementById('start-state').classList.add('hidden');
            document.getElementById('question-content').classList.remove('hidden');
            fetchQuestion();
        }

        function toggleMute() {
            state.muted = !state.muted;
            const icon = document.getElementById('mute-icon');
            if (state.muted) {
                icon.setAttribute('data-lucide', 'volume-x');
                document.getElementById('mute-btn').classList.add('opacity-50');
            } else {
                icon.setAttribute('data-lucide', 'volume-2');
                document.getElementById('mute-btn').classList.remove('opacity-50');
                AudioSys.init(); // Ensure context is ready if they unmute
            }
            lucide.createIcons();
        }

        function setLoading(isLoading) {
            const el = document.getElementById('loading-state');
            if (isLoading) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function showToast(isSuccess, message) {
            const toast = document.getElementById('feedback-toast');
            const icon = document.getElementById('feedback-icon');
            const text = document.getElementById('feedback-text');

            icon.textContent = isSuccess ? "üåü" : "‚ùå";
            text.textContent = message;
            
            toast.classList.remove('opacity-0', 'translate-y-10');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 2000);
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('api-key-input').value = state.customApiKey;
            }
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                state.customApiKey = key;
                localStorage.setItem('taal_api_key', key);
                toggleSettings();
                showToast(true, "Sleutel gestoor!");
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

    </script>
</body>
</html>
