<!DOCTYPE html>
<html lang="af">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taal Avontuur - Slim Vasvra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #f0f9ff;
            touch-action: manipulation;
        }
        .btn-pop {
            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-pop:active {
            transform: scale(0.95);
        }
        .correct-anim {
            animation: successPop 0.5s ease-out;
        }
        @keyframes successPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #86efac; }
            100% { transform: scale(1); }
        }
        .shake-anim {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <!-- Navbar -->
    <nav class="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center gap-2">
            <i data-lucide="rocket" class="h-6 w-6"></i>
            <h1 class="text-xl font-bold tracking-tight">Taal Avontuur</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleMute()" class="p-2 hover:bg-indigo-700 rounded-full transition" id="mute-btn">
                <i data-lucide="volume-2" class="h-5 w-5" id="mute-icon"></i>
            </button>
            <div class="bg-indigo-800 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                <i data-lucide="star" class="h-4 w-4 text-yellow-400 fill-yellow-400"></i>
                <span id="score">0</span>
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-indigo-700 rounded-full transition">
                <i data-lucide="settings" class="h-5 w-5"></i>
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <main class="flex-grow container mx-auto p-4 max-w-xl flex flex-col items-center justify-center relative">
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden absolute top-0 left-0 w-full h-full bg-white/95 z-50 flex flex-col p-6 rounded-xl shadow-xl backdrop-blur-sm overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-indigo-900 flex items-center gap-2">
                <i data-lucide="settings" class="h-6 w-6"></i> Instellings
            </h2>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2 uppercase">Taal Rigting</label>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="setDirection('AF_TO_EN')" id="btn-dir-af" class="p-3 rounded-lg border-2 text-left font-semibold transition-all hover:bg-indigo-50">
                        ðŸ‡¿ðŸ‡¦ Afrikaans âž” ðŸ‡¬ðŸ‡§ Engels
                    </button>
                    <button onclick="setDirection('EN_TO_AF')" id="btn-dir-en" class="p-3 rounded-lg border-2 text-left font-semibold transition-all hover:bg-indigo-50">
                        ðŸ‡¬ðŸ‡§ Engels âž” ðŸ‡¿ðŸ‡¦ Afrikaans
                    </button>
                    <button onclick="setDirection('MIXED')" id="btn-dir-mix" class="p-3 rounded-lg border-2 text-left font-semibold transition-all hover:bg-indigo-50">
                        ðŸ”€ Meng Alles
                    </button>
                </div>
            </div>

            <div class="mb-8">
                <label class="block text-sm font-bold text-gray-700 mb-2 uppercase">Begin-vlak</label>
                <div class="grid grid-cols-4 gap-2">
                    <!-- Grade buttons 1-12 -->
                    <script>
                        for(let i=1; i<=12; i++) {
                            document.write(`<button onclick="setStartingGrade(${i})" id="btn-grade-${i}" class="grade-selector-btn p-2 border-2 rounded-lg font-bold hover:bg-indigo-50 transition-all text-sm">${i}</button>`);
                        }
                    </script>
                </div>
            </div>

            <button onclick="toggleSettings()" class="mt-auto bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg">
                Gaan voort
            </button>
        </div>

        <!-- Grade Level Display -->
        <div class="w-full mb-6 flex justify-between items-end px-2">
            <div>
                <span class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Moeilikheidsgraad</span>
                <div class="text-2xl font-bold text-indigo-900 flex items-center gap-2">
                    Graad <span id="grade-display">1</span>
                </div>
            </div>
            <div class="text-right">
                <div class="flex gap-1" id="streak-dots">
                    <!-- Dots injected by JS -->
                </div>
                <span class="text-xs text-gray-400" id="streak-label">Nog 3 vir volgende vlak</span>
            </div>
        </div>

        <!-- Question Card -->
        <div id="quiz-card" class="bg-white w-full rounded-3xl shadow-xl border-b-8 border-indigo-100 p-6 text-center relative overflow-hidden min-h-[350px] flex flex-col justify-center">
            
            <!-- Start State -->
            <div id="start-state" class="absolute inset-0 bg-white flex flex-col items-center justify-center z-10 p-6">
                <div class="text-6xl mb-6">ðŸŽ“</div>
                <h2 class="text-3xl font-bold text-indigo-900 mb-2">Gereed?</h2>
                <p class="text-gray-600 mb-8 text-center">Kom ons leer nuwe woorde! Ons begin by Graad <span id="starting-grade-text" class="font-bold text-indigo-600">1</span>.</p>
                <button onclick="startGame()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-xl shadow-lg btn-pop hover:bg-indigo-700">
                    Begin!
                </button>
            </div>

            <!-- Question Content -->
            <div id="question-content" class="flex flex-col h-full hidden">
                <div class="mb-4 text-indigo-500 font-bold text-sm uppercase tracking-widest bg-indigo-50 inline-block px-3 py-1 rounded-full mx-auto" id="question-type">
                    AFRIKAANS âž” ENGELS
                </div>
                
                <div class="flex-grow flex flex-col justify-center items-center py-6">
                    <h2 id="question-word" class="text-4xl md:text-5xl font-black text-gray-800 break-words w-full leading-tight"></h2>
                </div>

                <div id="options-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-auto">
                    <!-- Buttons injected via JS -->
                </div>
            </div>

        </div>

        <!-- Feedback Toast -->
        <div id="feedback-toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-10 z-50 pointer-events-none w-11/12 max-w-sm justify-center">
            <span id="feedback-icon" class="text-2xl"></span>
            <span id="feedback-text" class="font-bold text-lg text-center"></span>
        </div>

    </main>

    <script>
        // --- State Management ---
        const state = {
            grade: 1,
            score: 0,
            consecutiveCorrect: 0,
            consecutiveIncorrect: 0,
            currentQuestion: null,
            muted: false,
            preferredDirection: 'MIXED', 
            db: [],
            isProcessing: false
        };

        // --- CSV Engine ---
        const VocabEngine = {
            async load() {
                try {
                    const response = await fetch('vocabulary.csv');
                    const text = await response.text();
                    this.parse(text);
                } catch (e) {
                    console.error("Failed to fetch vocabulary.csv, using internal fallback for safety.");
                    const fallbackCsv = "Grade,Afrikaans,English\n1,Kat,Cat\n1,Hond,Dog\n1,Huis,House";
                    this.parse(fallbackCsv);
                }
            },

            parse(text) {
                const lines = text.trim().split('\n');
                state.db = lines.slice(1).map(line => {
                    const parts = line.split(',');
                    return {
                        grade: parseInt(parts[0].trim()),
                        af: parts[1].trim(),
                        en: parts[2].trim()
                    };
                }).filter(item => !isNaN(item.grade));
                console.log(`Loaded ${state.db.length} words.`);
            },
            
            getQuestion(targetGrade) {
                let pool = state.db.filter(w => w.grade === targetGrade);
                
                // If pool is too small, broaden search to find distractors
                if (pool.length < 4) {
                    pool = state.db.filter(w => Math.abs(w.grade - targetGrade) <= 1);
                }
                
                if (pool.length === 0) pool = state.db;

                const correctItem = pool.filter(w => w.grade === targetGrade)[0] || pool[0];
                const realCorrectItem = pool.filter(w => w.grade === targetGrade).sort(() => 0.5 - Math.random())[0] || correctItem;
                
                let direction = state.preferredDirection === 'MIXED' ? 
                               (Math.random() > 0.5 ? 'AF_TO_EN' : 'EN_TO_AF') : 
                               state.preferredDirection;

                const questionWord = direction === 'AF_TO_EN' ? realCorrectItem.af : realCorrectItem.en;
                const correctWord = direction === 'AF_TO_EN' ? realCorrectItem.en : realCorrectItem.af;
                
                const isAnswerEnglish = (direction === 'AF_TO_EN');
                const otherWords = pool.filter(w => w.af !== realCorrectItem.af);
                const shuffled = otherWords.sort(() => 0.5 - Math.random());
                const distractors = shuffled.slice(0, 3).map(w => isAnswerEnglish ? w.en : w.af);
                
                return {
                    type: direction,
                    q: questionWord,
                    a: correctWord,
                    options: shuffleArray([correctWord, ...distractors])
                };
            }
        };

        // --- Audio System ---
        const AudioSys = {
            ctx: null,
            init() {
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone(freq, type, duration, startTime = 0) {
                if (state.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime + startTime;
                osc.start(now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                osc.stop(now + duration);
            },
            correct() { this.init(); this.playTone(523.25, 'sine', 0.1, 0); this.playTone(1046.50, 'sine', 0.4, 0.1); },
            incorrect() { this.init(); this.playTone(150, 'sawtooth', 0.4, 0); },
            levelUp() { this.init(); this.playTone(523.25, 'triangle', 0.1, 0); this.playTone(659.25, 'triangle', 0.1, 0.1); this.playTone(783.99, 'triangle', 0.1, 0.2); this.playTone(1046.50, 'triangle', 0.6, 0.3); },
            levelDown() { 
                this.init(); if (state.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.5);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
                osc.stop(this.ctx.currentTime + 0.5);
            }
        };

        // --- Logic & UI ---

        async function initApp() {
            await VocabEngine.load();
            lucide.createIcons();
            updateSettingsUI();
            updateGradeDisplay();
        }

        function generateQuestion() {
            state.currentQuestion = VocabEngine.getQuestion(state.grade);
            renderQuestion();
        }

        function renderQuestion() {
            const q = state.currentQuestion;
            const label = q.type === 'AF_TO_EN' ? "AFRIKAANS âž” ENGELS" : "ENGELS âž” AFRIKAANS";
            document.getElementById('question-type').textContent = label;
            document.getElementById('question-word').textContent = q.q;

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-indigo-50 hover:bg-indigo-100 text-indigo-900 font-bold py-6 px-4 rounded-xl border-2 border-indigo-200 transition-all btn-pop text-lg md:text-xl break-words leading-tight";
                btn.textContent = opt;
                btn.onclick = () => handleAnswer(opt, btn);
                grid.appendChild(btn);
            });
            updateStreakDisplay();
        }

        function handleAnswer(selected, btnElement) {
            if (state.isProcessing) return;
            state.isProcessing = true;

            const isCorrect = selected === state.currentQuestion.a;

            if (isCorrect) {
                AudioSys.correct();
                btnElement.classList.add('bg-green-500', 'border-green-600', 'text-white', 'correct-anim');
                showToast(true, "Dis reg! Mooi so.");
                state.score += 10 + (state.grade * 2);
                state.consecutiveCorrect++;
                state.consecutiveIncorrect = 0;

                if (state.consecutiveCorrect >= 3) {
                    setTimeout(() => levelUp(), 2000);
                } else {
                    setTimeout(() => { generateQuestion(); state.isProcessing = false; }, 2000);
                }
            } else {
                AudioSys.incorrect();
                btnElement.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shake-anim');
                const buttons = document.querySelectorAll('#options-grid button');
                buttons.forEach(b => {
                    if (b.textContent === state.currentQuestion.a) {
                        b.classList.add('bg-green-100', 'border-green-400', 'text-green-800');
                    }
                });
                showToast(false, `Die regte woord was: ${state.currentQuestion.a}`);
                state.consecutiveCorrect = 0;
                state.consecutiveIncorrect++;

                if (state.consecutiveIncorrect >= 2) {
                    setTimeout(() => levelDown(), 3500);
                } else {
                    setTimeout(() => { generateQuestion(); state.isProcessing = false; }, 3500);
                }
            }
            document.getElementById('score').textContent = state.score;
        }

        function levelUp() {
            const nextGrade = state.grade + 1;
            const hasData = state.db.some(w => w.grade === nextGrade);
            if (hasData) {
                AudioSys.levelUp();
                state.grade++;
                state.consecutiveCorrect = 0;
                showToast(true, `Graad ${state.grade}! Jy is slim! ðŸš€`);
                updateGradeDisplay();
                setTimeout(() => { generateQuestion(); state.isProcessing = false; }, 2000);
            } else {
                state.consecutiveCorrect = 0;
                generateQuestion();
                state.isProcessing = false;
            }
        }

        function levelDown() {
            AudioSys.levelDown();
            if (state.grade > 1) {
                state.grade--;
                showToast(false, `Terug na Graad ${state.grade}. Ons oefen nog bietjie.`);
            }
            state.consecutiveIncorrect = 0;
            updateGradeDisplay();
            setTimeout(() => { generateQuestion(); state.isProcessing = false; }, 1000);
        }

        function updateGradeDisplay() {
            document.getElementById('grade-display').textContent = state.grade;
            document.getElementById('starting-grade-text').textContent = state.grade;
            
            // Highlight active grade button in settings
            document.querySelectorAll('.grade-selector-btn').forEach(btn => {
                const bGrade = parseInt(btn.textContent);
                if (bGrade === state.grade) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-700');
                    btn.classList.remove('border-gray-200', 'text-gray-600');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-700');
                    btn.classList.add('border-gray-200', 'text-gray-600');
                }
            });
        }

        function setStartingGrade(g) {
            state.grade = g;
            state.consecutiveCorrect = 0;
            state.consecutiveIncorrect = 0;
            updateGradeDisplay();
        }

        function updateStreakDisplay() {
            const container = document.getElementById('streak-dots');
            container.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full ${i < state.consecutiveCorrect ? 'bg-green-500' : 'bg-gray-200'}`;
                container.appendChild(dot);
            }
            const remaining = 3 - state.consecutiveCorrect;
            document.getElementById('streak-label').textContent = remaining === 0 ? "Vlak op!" : `Nog ${remaining} vir volgende vlak`;
        }

        function setDirection(dir) { state.preferredDirection = dir; updateSettingsUI(); }

        function updateSettingsUI() {
            const buttons = { 'AF_TO_EN': document.getElementById('btn-dir-af'), 'EN_TO_AF': document.getElementById('btn-dir-en'), 'MIXED': document.getElementById('btn-dir-mix') };
            Object.values(buttons).forEach(btn => { btn.className = "p-3 rounded-lg border-2 text-left font-semibold transition-all hover:bg-indigo-50 border-gray-200 text-gray-600"; });
            const active = buttons[state.preferredDirection];
            active.className = "p-3 rounded-lg border-2 text-left font-semibold transition-all bg-indigo-100 border-indigo-500 text-indigo-900";
        }

        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }

        function showToast(isSuccess, message) {
            const toast = document.getElementById('feedback-toast');
            document.getElementById('feedback-icon').textContent = isSuccess ? "ðŸŒŸ" : "ðŸ’¡";
            document.getElementById('feedback-text').textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, isSuccess ? 2000 : 3500);
        }

        function toggleMute() {
            state.muted = !state.muted;
            const icon = document.getElementById('mute-icon');
            if (state.muted) { icon.setAttribute('data-lucide', 'volume-x'); document.getElementById('mute-btn').classList.add('opacity-50'); }
            else { icon.setAttribute('data-lucide', 'volume-2'); document.getElementById('mute-btn').classList.remove('opacity-50'); AudioSys.init(); }
            lucide.createIcons();
        }

        function startGame() {
            AudioSys.init();
            document.getElementById('start-state').classList.add('hidden');
            document.getElementById('question-content').classList.remove('hidden');
            generateQuestion();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        initApp();
    </script>
</body>
</html>
